<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Software Knowledge Tree</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"></script>
</head>
<body>
    <h1>Software Knowledge Tree</h1>
    <div id="tree-container"></div>

    <script nonce="{{ g.nonce }}">
        console.log(`Raw JSON from Flask: `, `{{ tree_data | tojson | safe }}`);
        const treeData = {{ tree_data | tojson | safe }};
    
        if (!treeData || typeof treeData.name === "undefined") {
            console.error("Invalid treeData structure:", treeData);
            document.getElementById("tree-container").innerHTML = "<p>Error loading knowledge tree.</p>";
        } else {
            console.log("Valid treeData:", treeData);
    
            const width = 1800, height = 1200;
            const margin = { top: 50, right: 250, bottom: 50, left: 250 };
    
            // Make the page scrollable
            const container = d3.select("#tree-container")
                .style("overflow", "scroll") // Enable scrolling
                .style("width", "100vw")
                .style("height", "100vh");
    
            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height)
                .call(d3.zoom().on("zoom", function (event) { // âœ… Fix Here
                    svg.attr("transform", event.transform);
                }))
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
    
            const root = d3.hierarchy(treeData);
            
            const treeLayout = d3.tree()
                .nodeSize([60, 200]);
    
            treeLayout(root);
    
            // Draw links
            svg.selectAll("line")
                .data(root.links())
                .enter().append("line")
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y)
                .style("stroke", "#555")
                .style("stroke-width", "2px");
    
            // Draw nodes
            svg.selectAll("circle")
                .data(root.descendants())
                .enter().append("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", 8)
                .style("fill", "#3498db")
                .style("stroke", "#222")
                .style("stroke-width", "2px");
    
            // Add labels
            svg.selectAll("text")
                .data(root.descendants())
                .enter().append("text")
                .attr("x", d => d.x)
                .attr("y", d => d.children ? d.y - 15 : d.y + 25)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .style("fill", "#000")
                .text(d => d.data.name)
                .call(wrapText, 150);
    
            function wrapText(selection, width) {
                selection.each(function () {
                    let text = d3.select(this);
                    let words = text.text().split(/\s+/).reverse();
                    let line = [];
                    let lineNumber = 0;
                    let lineHeight = 1.2;
                    let y = text.attr("y");
                    let x = text.attr("x");
                    let dy = parseFloat(text.attr("dy")) || 0;
                    let tspan = text.text(null)
                        .append("tspan")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("dy", dy + "em");
    
                    while (words.length) {
                        line.push(words.pop());
                        tspan.text(line.join(" "));
                        if (tspan.node().getComputedTextLength() > width) {
                            line.pop();
                            tspan.text(line.join(" "));
                            line = [words.pop()];
                            tspan = text.append("tspan")
                                .attr("x", x)
                                .attr("y", y)
                                .attr("dy", ++lineNumber * lineHeight + dy + "em")
                                .text(line.join(" "));
                        }
                    }
                });
            }
        }
    </script>      
</body>
</html>
